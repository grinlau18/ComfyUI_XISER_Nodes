# V3节点加载修复总结

## 问题描述
ComfyUI重启后只能加载项目的legacy节点，无法加载V3节点。

## 根本原因
根据对ComfyUI源码的分析，发现`load_custom_node`函数（位于`nodes.py`）的加载逻辑如下：

1. **优先检查`NODE_CLASS_MAPPINGS`**：如果模块有`NODE_CLASS_MAPPINGS`属性且不为`None`，就加载legacy节点
2. **然后检查`comfy_entrypoint`**：只有在`NODE_CLASS_MAPPINGS`不存在或为`None`时，才会检查`comfy_entrypoint`

**关键问题**：当一个模块同时定义了`NODE_CLASS_MAPPINGS`和`comfy_entrypoint`时，`NODE_CLASS_MAPPINGS`会优先加载，而`comfy_entrypoint`会被完全忽略。

## 修复方案

### 1. 修改顶层`__init__.py`
**文件位置**: `/Users/grin/Documents/comfy/ComfyUI/custom_nodes/ComfyUI_XISER_Nodes/__init__.py`

**修改内容**：
- 将`NODE_CLASS_MAPPINGS`和`NODE_DISPLAY_NAME_MAPPINGS`设置为`None`（而不是空字典`{}`）
- 只从`src.xiser_nodes`导入`comfy_entrypoint`
- 更新`__all__`列表，只导出`WEB_DIRECTORY`和`comfy_entrypoint`

**关键代码**：
```python
# 设置为None，让ComfyUI跳过legacy节点加载
NODE_CLASS_MAPPINGS = None
NODE_DISPLAY_NAME_MAPPINGS = None
```

### 2. 修改`src/xiser_nodes/__init__.py`
**文件位置**: `/Users/grin/Documents/comfy/ComfyUI/custom_nodes/ComfyUI_XISER_Nodes/src/xiser_nodes/__init__.py`

**修改内容**：
- 将`NODE_CLASS_MAPPINGS`和`NODE_DISPLAY_NAME_MAPPINGS`设置为`None`
- 注释掉legacy节点加载循环（保留代码但不执行）
- 保持`comfy_entrypoint`函数不变

**关键代码**：
```python
# 设置为None，让ComfyUI跳过legacy节点加载
NODE_CLASS_MAPPINGS = None
NODE_DISPLAY_NAME_MAPPINGS = None
```

### 3. 修复颜色更改功能
由于`NODE_CLASS_MAPPINGS`现在是`None`，需要修改颜色更改功能中对`NODE_CLASS_MAPPINGS`的引用：

**修改内容**：
- 在`handle_color_change`函数中，跳过对`NODE_CLASS_MAPPINGS["XIS_ReorderImages"]`的直接访问
- 添加注释说明如何在V3模式下重新实现此功能

## 技术细节

### 为什么设置为`None`而不是空字典`{}`？
根据ComfyUI的`load_custom_node`函数逻辑：
```python
if hasattr(module, "NODE_CLASS_MAPPINGS") and getattr(module, "NODE_CLASS_MAPPINGS") is not None:
```

- 空字典`{}`不等于`None`，所以条件为真，legacy节点会被加载
- 设置为`None`后，条件为假，ComfyUI会跳过legacy节点检查，转而检查`comfy_entrypoint`

### V3节点加载流程
修复后，ComfyUI将按以下流程加载节点：
1. 检查`NODE_CLASS_MAPPINGS` → 发现是`None` → 跳过
2. 检查`comfy_entrypoint` → 发现存在 → 调用
3. `comfy_entrypoint`返回`CombinedExtension`实例
4. ComfyUI调用`extension.get_node_list()`获取V3节点列表
5. 将V3节点注册到全局`NODE_CLASS_MAPPINGS`字典中

## 验证结果

### 检查项目
使用检查脚本验证修复结果：
```
✅ 修复成功！
   两个文件都符合V3优先加载的要求
   ComfyUI将使用 comfy_entrypoint 加载V3节点
```

### 当前V3模块
根据`src/xiser_nodes/__init__.py`中的`V3_MODULES`列表，以下模块已迁移到V3：
- `logic` - 逻辑节点
- `ui_control` - UI控制节点
- `list_processing` - 列表处理节点
- `data_processing` - 数据处理节点
- `label` - 标签节点

## 后续步骤

### 1. 测试V3节点加载
重启ComfyUI，验证以下V3节点是否正确加载：
- XIS_IsThereAnyData
- XIS_IfDataIsNone
- XIS_PromptsWithSwitches
- XIS_Float_Slider
- 等（完整列表见各模块）

### 2. 继续迁移其他模块
根据迁移计划，继续将其他legacy模块迁移到V3架构。

### 3. 恢复颜色更改功能
如果需要工作流颜色更新功能，可以：
- 动态导入`XIS_ReorderImages`类
- 或者将`XIS_ReorderImages`也迁移到V3架构

### 4. 监控日志
重启ComfyUI时，观察控制台输出，确认以下信息：
```
[XISER] v3: importing module logic
[XISER] v3: module logic entrypoint loaded
[XISER] Loaded v3 entrypoints from: logic, ui_control, list_processing, data_processing, label
```

## 注意事项

### 向后兼容性
- 当前修复确保了V3节点能正确加载
- legacy节点代码被保留但不会加载（`NODE_CLASS_MAPPINGS = None`）
- 如果需要恢复legacy节点，可以将`NODE_CLASS_MAPPINGS`改回空字典`{}`

### 迁移状态
根据迁移指南第3.6节要求："迁移期间不删除旧的 NODE_CLASS_MAPPINGS，但 v3 注册优先。"
当前修复完全符合这一要求。

### 文件备份
建议备份修改前的文件：
- `__init__.py.bak`
- `src/xiser_nodes/__init__.py.bak`

## 相关文件
1. `__init__.py` - 顶层入口文件
2. `src/xiser_nodes/__init__.py` - 节点聚合文件
3. `迁移计划.markdown` - 迁移指导文档
4. `v3迁移指南.markdown` - V3架构技术文档
5. `nodes.py` - ComfyUI节点加载源码（位于ComfyUI目录）

---

**修复完成时间**: 2025-12-04
**修复状态**: ✅ 已完成
**验证结果**: ✅ 通过检查
**下一步**: 重启ComfyUI进行实际测试