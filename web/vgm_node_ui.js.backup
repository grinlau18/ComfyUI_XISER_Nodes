/**
 * VGM Orchestrator节点UI增强
 */

import { app } from "/scripts/app.js";

function openKeyManager(node) {
    window.__XISER_ACTIVE_NODE_ID = node?.id ?? null;

    // 获取节点的当前key_profile值
    let currentProfile = "";
    if (node) {
        const keyWidget = node.widgets?.find(w => w.name === "key_profile");
        if (keyWidget && keyWidget.value) {
            currentProfile = keyWidget.value;
        }
    }

    const mgr = window.__XISER_KEY_MGR;
    if (mgr && typeof mgr.toggleModal === "function") {
        // 传递当前profile值给API Key管理面板
        mgr.restoreSelectionForActiveNode?.(currentProfile);
        mgr.toggleModal(true);
    } else {
        alert("VGM API Key manager not ready. Please reload.");
    }
}

// 更新API Key Management按钮文字
function updateApiKeyButtonText(node) {
    const buttonWidget = node.widgets?.find(w => w.name === "API key management");
    if (!buttonWidget) return;

    const keyWidget = node.widgets?.find(w => w.name === "key_profile");
    let profileName = keyWidget?.value;

    // 确保profileName是字符串类型
    if (profileName === null || profileName === undefined) {
        profileName = "";
    } else if (typeof profileName !== "string") {
        // 如果不是字符串，尝试转换为字符串
        profileName = String(profileName);
    }

    // 去除前后空格
    const trimmedName = profileName.trim();

    if (trimmedName !== "") {
        // 已选择API Key：显示"API Key  (名称) used"
        buttonWidget.label = `API Key (${trimmedName}) used`;
    } else {
        // 未选择API Key：显示"Please set the API Key"
        buttonWidget.label = "Please set the API Key";
    }
}

// 扩展视频节点
app.registerExtension({
    name: "XISER_Nodes.VideoUI",
    async beforeRegisterNodeDef(nodeType, nodeData, app) {
        // 检查节点名称，可能是display_name "VGM Orchestrator" 或 node_id "XIS_VGMOrchestrator"
        if (nodeData.name === "VGM Orchestrator" || nodeData.name === "XIS_VGMOrchestrator") {
            // 保存原始onNodeCreated
            const originalOnNodeCreated = nodeType.prototype.onNodeCreated;

            // 定义提供者提示信息 - 根据API文档和providers_wan.py配置更新
            const providerHints = {
                // 参考生视频模型 (r2v)
                "wan2.6-r2v": {
                    providerType: "r2v",
                    hasImageInput: false,
                    hasVideoUrlInput: true,
                    hasResolution: false,
                    hasAudio: false,
                    hasPromptExtend: false,
                    hasTemplate: false,
                    hasShotType: true,
                    hasSize: true,
                    supportedRegions: ["china", "singapore", "virginia"],
                    supportedDurations: [5, 10],
                    supportedSizes: [
                        "1280*720", "720*1280", "960*960", "1088*832", "832*1088",
                        "1920*1080", "1080*1920", "1440*1440", "1632*1248", "1248*1632"
                    ],
                    maxPromptLength: 1500,
                },
                // 图生视频模型 (i2v) - 基于首帧
                "wan2.6-i2v": {
                    providerType: "i2v",
                    hasImageInput: true,
                    hasVideoUrlInput: false,
                    hasResolution: true,
                    hasAudio: true,
                    hasPromptExtend: true,
                    hasTemplate: true,
                    hasShotType: true,
                    hasSize: false,
                    supportedRegions: ["china", "singapore", "virginia"],
                    supportedDurations: [5, 10, 15],
                    supportedResolutions: ["720P", "1080P"],
                    maxPromptLength: 1500,
                },
                "wan2.5-i2v-preview": {
                    providerType: "i2v",
                    hasImageInput: true,
                    hasVideoUrlInput: false,
                    hasResolution: true,
                    hasAudio: true,
                    hasPromptExtend: true,
                    hasTemplate: false,
                    hasShotType: false,
                    hasSize: false,
                    supportedRegions: ["china", "singapore", "virginia"],
                    supportedDurations: [5, 10],
                    supportedResolutions: ["480P", "720P", "1080P"],
                    maxPromptLength: 1500,
                },
                "wan2.2-i2v-flash": {
                    providerType: "i2v",
                    hasImageInput: true,
                    hasVideoUrlInput: false,
                    hasResolution: true,
                    hasAudio: false,
                    hasPromptExtend: true,
                    hasTemplate: false,
                    hasShotType: false,
                    hasSize: false,
                    supportedRegions: ["china", "singapore", "virginia"],
                    supportedDurations: [5],
                    supportedResolutions: ["480P", "720P", "1080P"],
                    maxPromptLength: 800,
                },
                "wan2.2-i2v-plus": {
                    providerType: "i2v",
                    hasImageInput: true,
                    hasVideoUrlInput: false,
                    hasResolution: true,
                    hasAudio: false,
                    hasPromptExtend: true,
                    hasTemplate: false,
                    hasShotType: false,
                    hasSize: false,
                    supportedRegions: ["china", "singapore", "virginia"],
                    supportedDurations: [5],
                    supportedResolutions: ["480P", "1080P"],
                    maxPromptLength: 800,
                },
                "wanx2.1-i2v-plus": {
                    providerType: "i2v",
                    hasImageInput: true,
                    hasVideoUrlInput: false,
                    hasResolution: true,
                    hasAudio: false,
                    hasPromptExtend: true,
                    hasTemplate: true,
                    hasShotType: false,
                    hasSize: false,
                    supportedRegions: ["china", "singapore", "virginia"],
                    supportedDurations: [5],
                    supportedResolutions: ["720P"],
                    maxPromptLength: 800,
                },
                "wanx2.1-i2v-turbo": {
                    providerType: "i2v",
                    hasImageInput: true,
                    hasVideoUrlInput: false,
                    hasResolution: true,
                    hasAudio: false,
                    hasPromptExtend: true,
                    hasTemplate: true,
                    hasShotType: false,
                    hasSize: false,
                    supportedRegions: ["china", "singapore", "virginia"],
                    supportedDurations: [3, 4, 5],
                    supportedResolutions: ["480P", "720P"],
                    maxPromptLength: 800,
                },
                // 图生视频模型 (kf2v) - 首尾帧生视频
                "wan2.2-kf2v-flash": {
                    providerType: "kf2v",
                    hasImageInput: true,
                    hasVideoUrlInput: false,
                    hasResolution: true,
                    hasAudio: false,
                    hasPromptExtend: true,
                    hasTemplate: true,
                    hasShotType: false, // 首尾帧不支持shot_type
                    hasSize: false,
                    supportedRegions: ["china", "singapore"], // 首尾帧不支持弗吉尼亚
                    supportedDurations: [5], // 首尾帧固定5秒
                    supportedResolutions: ["480P", "720P", "1080P"],
                    maxPromptLength: 800,
                },
                "wanx2.1-kf2v-plus": {
                    providerType: "kf2v",
                    hasImageInput: true,
                    hasVideoUrlInput: false,
                    hasResolution: true,
                    hasAudio: false,
                    hasPromptExtend: true,
                    hasTemplate: true,
                    hasShotType: false, // 首尾帧不支持shot_type
                    hasSize: false,
                    supportedRegions: ["china", "singapore"], // 首尾帧不支持弗吉尼亚
                    supportedDurations: [5], // 首尾帧固定5秒
                    supportedResolutions: ["720P"],
                    maxPromptLength: 800,
                }
            };

            // 辅助函数：处理分组提供者名称
            const getActualProviderName = (groupedName) => {
                if (groupedName.startsWith("alibaba/")) {
                    return groupedName.substring(8); // 移除"alibaba/"前缀
                }
                return groupedName;
            };

            // 应用提供者特定的控件可见性
            const applyProvider = (node, providerVal) => {
                // 防止递归调用
                if (node._isApplyingProvider) return;
                node._isApplyingProvider = true;

                try {
                    const actualProvider = getActualProviderName(providerVal);
                    const rawHint = providerHints[actualProvider] || {};

                    // 确保hint对象有所有必要的属性，防止undefined错误
                    const safeHint = {
                        providerType: rawHint.providerType || "i2v",
                        hasImageInput: !!rawHint.hasImageInput,
                        hasVideoUrlInput: !!rawHint.hasVideoUrlInput,
                        hasResolution: !!rawHint.hasResolution,
                        hasAudio: !!rawHint.hasAudio,
                        hasPromptExtend: !!rawHint.hasPromptExtend,
                        hasTemplate: !!rawHint.hasTemplate,
                        hasShotType: !!rawHint.hasShotType,
                        hasSize: !!rawHint.hasSize,
                        supportedRegions: Array.isArray(rawHint.supportedRegions) ? rawHint.supportedRegions : ["china", "singapore", "virginia"],
                        supportedDurations: Array.isArray(rawHint.supportedDurations) ? rawHint.supportedDurations : [5],
                        supportedSizes: Array.isArray(rawHint.supportedSizes) ? rawHint.supportedSizes : [],
                        supportedResolutions: Array.isArray(rawHint.supportedResolutions) ? rawHint.supportedResolutions : [],
                        maxPromptLength: rawHint.maxPromptLength || 1000
                    };

                    const isR2V = safeHint.providerType === "r2v";
                    const isI2V = safeHint.providerType === "i2v";
                    const isKf2V = safeHint.providerType === "kf2v";

                    // 获取节点的高级设置状态
                    const advancedSettingsKey = "xiser.vgm.advancedSettings";
                    const savedState = localStorage.getItem(advancedSettingsKey);
                    const expandedState = savedState ? JSON.parse(savedState) : {};
                    const isAdvancedExpanded = expandedState[node.id] || false;

                let needsCanvasUpdate = false;

                (node.widgets || []).forEach(w => {
                    if (!w || !w.name) return;
                    if (w.name === "key_profile" || w.name === "API key management" || w.name === "Advanced Settings") {
                        return;
                    }

                    // 确保所有控件的options都是数组（防止ComboWidget错误）
                    if (w.options === undefined || w.options === null || !Array.isArray(w.options)) {
                        w.options = [];
                        needsCanvasUpdate = true;
                    }

                    // 根据提供者类型控制控件可见性
                    switch (w.name) {
                        // 参考生视频相关控件
                        case "reference_video_url":
                            if (w.hidden !== !isR2V || w.disabled !== !isR2V) {
                                w.hidden = !isR2V;
                                w.disabled = !isR2V;
                                needsCanvasUpdate = true;
                            }
                            break;
                        case "size":
                            if (w.hidden !== !isR2V || w.disabled !== !isR2V) {
                                w.hidden = !isR2V;
                                w.disabled = !isR2V;
                                needsCanvasUpdate = true;
                            }
                            // 如果控件可见，更新选项
                            if (!w.hidden && safeHint.supportedSizes && Array.isArray(safeHint.supportedSizes)) {
                                const oldOptions = JSON.stringify(w.options || []);
                                const newOptions = JSON.stringify(safeHint.supportedSizes);
                                if (oldOptions !== newOptions) {
                                    w.options = safeHint.supportedSizes.slice(); // 使用副本确保是数组
                                    needsCanvasUpdate = true;
                                }
                                // 如果当前值不在支持的分辨率中，重置为默认值
                                if (!safeHint.supportedSizes.includes(w.value)) {
                                    w.value = safeHint.supportedSizes[0] || "1280*720";
                                    needsCanvasUpdate = true;
                                }
                            }
                            break;
                        case "shot_type":
                            if (w.hidden !== !safeHint.hasShotType || w.disabled !== !safeHint.hasShotType) {
                                w.hidden = !safeHint.hasShotType;
                                w.disabled = !safeHint.hasShotType;
                                needsCanvasUpdate = true;
                            }
                            break;

                        // 图生视频相关控件
                        case "pack_images":
                            const shouldShowImages = isI2V || isKf2V;
                            if (w.hidden !== !shouldShowImages || w.disabled !== !shouldShowImages) {
                                w.hidden = !shouldShowImages;
                                w.disabled = !shouldShowImages;
                                needsCanvasUpdate = true;
                            }
                            break;
                        case "audio_url":
                            if (w.hidden !== !safeHint.hasAudio || w.disabled !== !safeHint.hasAudio) {
                                w.hidden = !safeHint.hasAudio;
                                w.disabled = !safeHint.hasAudio;
                                needsCanvasUpdate = true;
                            }
                            break;
                        case "resolution":
                            if (w.hidden !== !safeHint.hasResolution || w.disabled !== !safeHint.hasResolution) {
                                w.hidden = !safeHint.hasResolution;
                                w.disabled = !safeHint.hasResolution;
                                needsCanvasUpdate = true;
                            }
                            // 如果控件可见，更新选项
                            if (!w.hidden && safeHint.supportedResolutions && Array.isArray(safeHint.supportedResolutions)) {
                                const oldOptions = JSON.stringify(w.options || []);
                                const newOptions = JSON.stringify(safeHint.supportedResolutions);
                                if (oldOptions !== newOptions) {
                                    w.options = safeHint.supportedResolutions.slice(); // 使用副本确保是数组
                                    needsCanvasUpdate = true;
                                }
                                // 如果当前值不在支持的分辨率中，重置为默认值
                                if (!safeHint.supportedResolutions.includes(w.value)) {
                                    w.value = safeHint.supportedResolutions[0] || "720P";
                                    needsCanvasUpdate = true;
                                }
                            }
                            break;
                        case "prompt_extend":
                            if (w.hidden !== !safeHint.hasPromptExtend || w.disabled !== !safeHint.hasPromptExtend) {
                                w.hidden = !safeHint.hasPromptExtend;
                                w.disabled = !safeHint.hasPromptExtend;
                                needsCanvasUpdate = true;
                            }
                            break;
                        case "template":
                            if (w.hidden !== !safeHint.hasTemplate || w.disabled !== !safeHint.hasTemplate) {
                                w.hidden = !safeHint.hasTemplate;
                                w.disabled = !safeHint.hasTemplate;
                                needsCanvasUpdate = true;
                            }
                            break;

                        // 时长控件 - 根据模型支持的时长动态更新选项
                        case "duration":
                            // 时长控件始终可见
                            if (w.hidden !== false || w.disabled !== false) {
                                w.hidden = false;
                                w.disabled = false;
                                needsCanvasUpdate = true;
                            }
                            // 更新时长选项
                            if (safeHint.supportedDurations && Array.isArray(safeHint.supportedDurations)) {
                                const oldOptions = JSON.stringify(w.options || []);
                                const newOptions = JSON.stringify(safeHint.supportedDurations);
                                if (oldOptions !== newOptions) {
                                    w.options = safeHint.supportedDurations.slice(); // 使用副本确保是数组
                                    needsCanvasUpdate = true;
                                }
                                // 如果当前值不在支持的时长中，重置为默认值
                                if (!safeHint.supportedDurations.includes(w.value)) {
                                    w.value = safeHint.supportedDurations[0] || 5;
                                    needsCanvasUpdate = true;
                                }
                            }
                            break;

                        // 地区控件 - 根据模型支持的地区动态更新选项
                        case "region":
                            // 根据高级设置状态控制可见性
                            if (w.hidden !== !isAdvancedExpanded || w.disabled !== !isAdvancedExpanded) {
                                w.hidden = !isAdvancedExpanded;
                                w.disabled = !isAdvancedExpanded;
                                needsCanvasUpdate = true;
                            }

                            // 只有在控件可见时才更新选项
                            if (!w.hidden) {
                                // 获取模型支持的地区
                                const supportedRegions = safeHint.supportedRegions || ["china", "singapore", "virginia"];

                                // 更新选项
                                if (w.options && Array.isArray(w.options)) {
                                    // 过滤选项，只保留支持的地区
                                    const filteredOptions = w.options.filter(option =>
                                        supportedRegions.includes(option)
                                    );

                                    // 如果当前值不在支持的地区中，重置为默认值
                                    if (!supportedRegions.includes(w.value)) {
                                        w.value = "china";
                                        needsCanvasUpdate = true;
                                    }

                                    // 更新选项（如果需要）
                                    const oldOptions = JSON.stringify(w.options);
                                    const newOptions = JSON.stringify(filteredOptions);
                                    if (oldOptions !== newOptions) {
                                        w.options = filteredOptions.slice(); // 使用副本确保是数组
                                        needsCanvasUpdate = true;
                                    }
                                }
                            }
                            break;

                        // 通用控件（始终显示）
                        case "provider":
                        case "prompt":
                        case "seed":
                            if (w.hidden !== false || w.disabled !== false) {
                                w.hidden = false;
                                w.disabled = false;
                                needsCanvasUpdate = true;
                            }
                            break;

                        // 低频控件（根据高级设置状态）
                        case "negative_prompt":
                        case "watermark":
                        case "endpoint_override":
                        case "polling_interval":
                        case "max_polling_time":
                            if (w.hidden !== !isAdvancedExpanded || w.disabled !== !isAdvancedExpanded) {
                                w.hidden = !isAdvancedExpanded;
                                w.disabled = !isAdvancedExpanded;
                                needsCanvasUpdate = true;
                            }
                            break;
                    }
                });

                // 只在需要时触发画布更新
                if (needsCanvasUpdate && window.app?.graph) {
                    window.app.graph.setDirtyCanvas(true, true);
                }
                } catch (error) {
                    console.error("Error in applyProvider:", error);
                } finally {
                    node._isApplyingProvider = false;
                }
            };

            nodeType.prototype.onNodeCreated = function() {
                // 调用原始方法
                if (originalOnNodeCreated) {
                    originalOnNodeCreated.apply(this, arguments);
                }

                // 存储每个节点的高级设置展开状态
                const advancedSettingsKey = "xiser.vgm.advancedSettings";

                // 初始化高级设置状态
                const savedState = localStorage.getItem(advancedSettingsKey);
                const expandedState = savedState ? JSON.parse(savedState) : {};

                // 添加API Key管理按钮
                if (!this.widgets.some(w => w.name === "API key management")) {
                    this.addWidget("button", "API key management", "open", () => openKeyManager(this));
                }

                // 隐藏key_profile控件（参考LLM节点实现）
                const keyWidget = this.widgets.find(w => w.name === "key_profile");
                if (keyWidget) {
                    keyWidget.hidden = true;
                    keyWidget.computeSize = () => [0, 0];

                    // 检查节点是否已经有key_profile值（复制节点时可能已经设置了）
                    const existingValue = keyWidget.value;
                    if (!existingValue || existingValue.trim() === "") {
                        // 节点没有值，从localStorage读取（如果有的话）
                        const storageKey = "xiser.vgm.profileMap";
                        const raw = localStorage.getItem(storageKey);
                        const map = raw ? JSON.parse(raw) : {};
                        const stored = map[this.id];
                        if (stored) {
                            keyWidget.value = stored;
                        }
                    }
                }

                // 初始化按钮文字
                updateApiKeyButtonText(this);

                // 添加高级设置按钮
                if (!this.widgets.some(w => w.name === "Advanced Settings")) {
                    // 确保expandedState[this.id]有值
                    if (expandedState[this.id] === undefined) {
                        expandedState[this.id] = false;
                    }
                    const isExpanded = expandedState[this.id];

                    const toggleAdvancedSettings = () => {
                        // 切换展开状态
                        const newExpandedState = !expandedState[this.id];
                        expandedState[this.id] = newExpandedState;
                        localStorage.setItem(advancedSettingsKey, JSON.stringify(expandedState));

                        // 更新按钮文字
                        const advButton = this.widgets.find(w => w.name === "Advanced Settings");
                        if (advButton) {
                            advButton.label = newExpandedState ? "Hide Advanced Settings" : "Show Advanced Settings";
                        }

                        // 应用提供者特定的可见性（这会覆盖高级设置的状态）
                        const providerWidget = this.widgets.find(w => w.name === "provider");
                        if (providerWidget) {
                            applyProvider(this, providerWidget.value);
                        }

                        // 触发画布更新
                        if (window.app?.graph) {
                            window.app.graph.setDirtyCanvas(true, true);
                        }
                    };

                    this.addWidget("button", "Advanced Settings",
                        isExpanded ? "Hide Advanced Settings" : "Show Advanced Settings",
                        toggleAdvancedSettings);

                    // 确保按钮label正确设置
                    const advButton = this.widgets.find(w => w.name === "Advanced Settings");
                    if (advButton) {
                        advButton.label = isExpanded ? "Hide Advanced Settings" : "Show Advanced Settings";
                    }
                }

                // 立即初始化所有控件的options，防止ComboWidget错误
                this.widgets.forEach(w => {
                    if (!w || !w.name) return;
                    if (w.name === "key_profile" || w.name === "API key management" || w.name === "Advanced Settings") {
                        return;
                    }

                    // 确保所有控件的options都是数组
                    if (w.options === undefined || w.options === null || !Array.isArray(w.options)) {
                        w.options = [];
                    }
                });

                // 添加provider变更监听
                const providerWidget = this.widgets.find(w => w.name === "provider");
                if (providerWidget) {
                    const node = this; // 保存节点引用
                    const origCallback = providerWidget.callback;
                    providerWidget.callback = function() {
                        if (origCallback) origCallback.apply(this, arguments);
                        applyProvider(node, this.value);
                    };

                    // 初始应用提供者特定的可见性
                    setTimeout(() => {
                        applyProvider(node, providerWidget.value);
                    }, 10);
                }

                // 保存更新后的状态到localStorage
                localStorage.setItem(advancedSettingsKey, JSON.stringify(expandedState));
            };

            // 保存原始onConfigure
            const originalOnConfigure = nodeType.prototype.onConfigure;

            nodeType.prototype.onConfigure = function() {
                // 调用原始方法
                if (originalOnConfigure) {
                    originalOnConfigure.apply(this, arguments);
                }

                // 立即初始化所有控件的options，防止ComboWidget错误
                this.widgets.forEach(w => {
                    if (!w || !w.name) return;
                    if (w.name === "key_profile" || w.name === "API key management" || w.name === "Advanced Settings") {
                        return;
                    }

                    // 确保所有控件的options都是数组
                    if (w.options === undefined || w.options === null || !Array.isArray(w.options)) {
                        w.options = [];
                    }
                });

                // 更新API Key按钮文字
                updateApiKeyButtonText(this);

                // 应用提供者特定的可见性
                const providerWidget = this.widgets.find(w => w.name === "provider");
                if (providerWidget) {
                    applyProvider(this, providerWidget.value);
                }
            };
        }
    },
    setup() {
        // 监听API Key选择变化事件（使用与LLM相同的事件）
        window.addEventListener("xiser-llm-profile-changed", e => {
            let profile = (e.detail && e.detail.profile) || "";
            // 确保profile是字符串类型
            if (typeof profile !== "string") {
                profile = String(profile);
            }
            const nodeId = e.detail?.nodeId;
            const app = window.app;
            const nodes = app?.graph?._nodes || [];

            nodes.forEach(n => {
                if (n?.comfyClass !== "XIS_VGMOrchestrator") return;
                if (nodeId != null && n.id !== nodeId) return;

                const w = n.widgets?.find(x => x.name === "key_profile");
                if (w) {
                    w.value = profile;

                    // 保存到localStorage
                    const storageKey = "xiser.vgm.profileMap";
                    const raw = localStorage.getItem(storageKey);
                    const map = raw ? JSON.parse(raw) : {};
                    map[n.id] = profile;
                    localStorage.setItem(storageKey, JSON.stringify(map));
                }

                // 更新按钮文字
                updateApiKeyButtonText(n);
            });

            if (app?.graph) {
                app.graph.setDirtyCanvas(true, true);
            }
        });
    }
});