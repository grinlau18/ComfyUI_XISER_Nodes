# XIS VGM Orchestrator 节点使用说明

## 概述

XIS VGM Orchestrator 是一个基于万相2.6参考生视频模型的ComfyUI节点，支持基于参考视频的角色形象和音色生成新视频。节点采用模块化设计，便于后续支持更多视频模型。

## 功能特性

### 核心功能
- **参考视频生成**: 基于参考视频的角色形象和音色生成新视频
- **多镜头叙事**: 支持single（单镜头）和multi（多镜头）模式
- **多种分辨率**: 支持720P和1080P档位的多种分辨率
- **可调时长**: 支持5秒和10秒视频生成
- **进度显示**: 实时显示任务创建、轮询和下载进度
- **结果预览**: 生成视频可直接在ComfyUI中预览

### 技术特性
- **模块化架构**: 基于提供者模式，易于扩展新模型
- **API密钥管理**: 加密存储API密钥，支持多配置文件
- **输入验证**: 自动验证参数合法性
- **异步处理**: 支持长时间视频生成任务
- **错误处理**: 完善的错误处理和用户反馈

## 安装要求

### 系统要求
- ComfyUI V3 环境
- Python 3.8+
- 网络连接（用于API调用）

### Python依赖
节点使用以下核心依赖：
- `requests` - HTTP请求库
- `cryptography` - API密钥加密
- `torch` - 张量处理

## 快速开始

### 1. 添加节点
在ComfyUI中，节点位于 `XISER_Nodes/Video` 类别下，名称为 `VGM Orchestrator`。

### 2. 配置API密钥
1. 点击节点上的 "🔑 API Key Management" 按钮
2. 在弹出窗口中：
   - 输入配置文件名称（如 `wan_production`）
   - 输入万相API密钥（格式：`sk-xxxx`）
   - 点击 "Save" 保存
3. 在节点的 `key_profile` 参数中选择刚才创建的配置文件

### 3. 基本使用流程

#### 输入参数说明：
- **provider**: 视频提供者（目前仅支持"万相2.6参考生视频"）
- **prompt**: 视频描述提示词（不超过1500字符）
- **reference_video**: 参考视频输入（单视频）
- **pack_videos**: 参考视频包（多视频，最多3个）
- **size**: 输出视频分辨率（如1280*720）
- **duration**: 输出视频时长（5或10秒）
- **shot_type**: 镜头类型（single/multi）
- **seed**: 随机种子（固定值确保可重复性）

#### 输出参数说明：
- **video**: 生成的视频张量
- **video_url**: 视频下载URL
- **task_id**: 任务ID（用于调试）
- **usage_info**: 使用信息JSON

### 4. 示例工作流

```
1. 添加 VGM Orchestrator 节点
2. 配置API密钥
3. 连接参考视频输入
4. 设置提示词："character1在公园里散步"
5. 选择分辨率：1280*720
6. 选择时长：5秒
7. 选择镜头类型：multi
8. 运行生成
```

## 详细参数说明

### 必选参数

#### 1. 提示词 (prompt)
- **描述**: 视频内容描述
- **限制**: 不超过1500字符
- **示例**: "character1在沙发上开心地看电影"

#### 2. 参考视频 (reference_video / pack_videos)
- **格式**: MP4、MOV
- **时长**: 2-30秒
- **大小**: 不超过100MB
- **内容**: 每个视频仅包含一个角色
- **数量**: 最多3个视频
- **角色对应**: 第1个URL对应character1，第2个对应character2，以此类推

### 可选参数

#### 1. 分辨率 (size)
**720P档位**:
- 1280*720 (16:9)
- 720*1280 (9:16)
- 960*960 (1:1)
- 1088*832 (4:3)
- 832*1088 (3:4)

**1080P档位**:
- 1920*1080 (16:9)
- 1080*1920 (9:16)
- 1440*1440 (1:1)
- 1632*1248 (4:3)
- 1248*1632 (3:4)

#### 2. 镜头类型 (shot_type)
- **single**: 单镜头，固定视角
- **multi**: 多镜头叙事，支持镜头切换

#### 3. 负面提示词 (negative_prompt)
- **描述**: 指定不希望出现的内容
- **限制**: 不超过500字符
- **示例**: "低分辨率、错误、最差质量"

#### 4. 高级参数（默认折叠）
- **watermark**: 是否添加水印（默认False）
- **seed**: 随机种子（0-2147483647，默认42）
- **endpoint_override**: 覆盖API端点（可选）
- **polling_interval**: 轮询间隔（1-60秒，默认5）
- **max_polling_time**: 最大轮询时间（30-1800秒，默认300）

## API配置

### 万相API端点
- **北京**: `https://dashscope.aliyuncs.com/api/v1/services/aigc/video-generation/video-synthesis`
- **新加坡**: `https://dashscope-intl.aliyuncs.com/api/v1/services/aigc/video-generation/video-synthesis`
- **弗吉尼亚**: `https://dashscope-us.aliyuncs.com/api/v1/services/aigc/video-generation/video-synthesis`

### 请求头
```
Content-Type: application/json
Authorization: Bearer sk-xxxx
X-DashScope-Async: enable
```

## 错误处理

### 常见错误及解决方案

#### 1. API密钥错误
- **症状**: "未找到API密钥" 或 "API请求失败"
- **解决**: 检查API密钥配置，确保密钥有效

#### 2. 参数验证错误
- **症状**: "提示词长度超过限制" 或 "不支持的尺寸"
- **解决**: 检查参数是否符合要求

#### 3. 网络超时
- **症状**: "任务超时"
- **解决**: 增加 `max_polling_time` 参数值

#### 4. 视频处理失败
- **症状**: "任务失败" 状态
- **解决**: 检查参考视频格式和内容，调整提示词

## 开发说明

### 架构设计

#### 1. 模块化结构
```
src/xiser_nodes/video/
├── base.py              # 基础类和接口
├── registry.py          # 提供者注册表
├── providers_wan.py     # 万相提供者实现
└── video_v3.py          # 主节点实现
```

#### 2. 扩展新提供者
要添加新的视频模型提供者：

1. 创建新的提供者类，继承 `BaseVideoProvider`
2. 实现所有抽象方法
3. 在 `providers_*.py` 文件中注册
4. 提供者会自动出现在节点下拉框中

#### 3. Web界面
- **文件**: `web/vgm_node_ui.js`
- **功能**: API密钥管理、高级设置折叠、UI优化

### 测试
运行组件测试：
```bash
python test_video_components.py
```

## 限制和注意事项

### 技术限制
1. **视频编码**: 当前版本使用虚拟视频张量，实际视频编码需要额外实现
2. **大文件处理**: 参考视频需符合API要求（≤100MB）
3. **异步处理**: 视频生成需要时间，节点会轮询状态

### 使用建议
1. **提示词优化**: 使用具体、详细的描述
2. **参考视频质量**: 使用清晰、稳定的参考视频
3. **参数调整**: 根据需求调整分辨率和时长
4. **错误监控**: 关注控制台输出和节点状态

## 更新日志

### v1.0.0 (初始版本)
- 支持万相2.6参考生视频模型
- 完整的API密钥管理
- 进度显示和结果预览
- 模块化架构设计

## 技术支持

如有问题或建议，请：
1. 查看控制台错误信息
2. 检查参数设置
3. 参考API文档
4. 联系开发者

## 许可证

本项目基于MIT许可证发布。