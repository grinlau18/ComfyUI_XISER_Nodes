# XISER-Nodes v3架构迁移总计划

## 项目概述
将XISER-Nodes从legacy架构逐步迁移到ComfyUI v3架构，遵循"逐步转向v3，已迁移节点不再兼容legacy"的原则。

## 当前状态（2025-12-04）
- **总节点数**: 55个
- **已迁移节点**: 34个 (61.8%) - B级节点100%完成
- **待迁移节点**: 21个 (38.2%) - A级15个 + S级13个
- **迁移阶段**: B级节点完成，开始A级节点迁移

## 新的后端迁移策略

### 核心原则
1. **逐步转向纯v3架构**：已迁移的v3节点不再考虑兼容legacy
2. **未迁移节点暂时不加载**：等待迁移完成后再加载
3. **前端保持不变**：JS前端逻辑全部保留，通过v3自定义类型交互

### 加载机制
已实现智能加载机制，只加载已迁移的v3模块：
- ✅ **已迁移模块** (6个): 包含34个B级节点
- 🔄 **A级待迁移模块** (7个): 包含15个节点
- 🔄 **S级待迁移模块** (9个): 包含13个节点

## 迁移路线图

### 阶段1：B级节点迁移 ✅ 已完成
**时间**: 已完成
**节点**: 27个简单节点 + 7个UI控制节点 = 34个节点
**状态**: 100%完成，已投入生产使用

### 阶段2：A级节点迁移 🔄 进行中
**时间**: 3周（分3个子阶段）
**节点**: 15个中等复杂度节点
**详细计划**: 见 `A级节点迁移计划.md`

#### 子阶段2.1：基础图像处理节点
**时间**: 第1周
**节点**: 6个无前端交互的基础节点
1. XIS_LoadImage
2. XIS_ResizeToDivisible
3. XIS_CropImage
4. XIS_ResizeImageOrMask
5. XIS_DynamicKSampler
6. XIS_LatentBlendNode

#### 子阶段2.2：中等复杂度节点
**时间**: 第2周
**节点**: 8个无前端交互的节点
1. XIS_InvertMask
2. XIS_ImageMaskMirror
3. XIS_ReorderImageMaskGroups
4. XIS_MaskCompositeOperation
5. XIS_MaskBatchProcessor
6. XIS_CompositorProcessor
7. XIS_ImagePuzzle
8. XIS_ShapeData

#### 子阶段2.3：有前端交互的复杂节点
**时间**: 第3周
**节点**: 2个有JS前端的节点
1. XIS_PSDLayerExtractor (前端: `psd_upload.js`)
2. XIS_ImageAdjustAndBlend (前端: `adjust_image.js`)

### 阶段3：S级节点迁移 📅 待开始
**时间**: 待A级完成后开始
**节点**: 13个高复杂度节点
**特点**: 全部有复杂JS前端交互

## 技术架构

### 后端架构（v3）
```python
# 所有节点继承自io.ComfyNode
class XIS_NodeName(io.ComfyNode):

    @classmethod
    def define_schema(cls):
        return io.Schema(
            node_id="XIS_NodeName",
            display_name="XIS Node Name",
            category="XISER_Nodes/Category",
            inputs=[...],
            outputs=[...],  # 必须包含display_name
        )

    @classmethod
    def execute(cls, ...):
        return io.NodeOutput(...)
```

### 前端兼容性
- **JS前端不变**: 所有`app.registerExtension`、`addDOMWidget`逻辑保留
- **自定义类型交互**: 通过`io.Custom`类型与JS前端交互
- **双界面兼容**: 遵循Vue/传统界面兼容规范

### 数据格式
- **图像数据**: HWC RGBA格式，float [0,1]，列表容器
- **自定义类型**: 保持与legacy相同的JSON结构
- **序列化**: 完全兼容工作流保存/加载

## 质量保证

### 测试策略
1. **单元测试**: 每个节点迁移后立即测试
2. **集成测试**: 节点间连接和数据流测试
3. **前端测试**: JS交互和界面兼容性测试
4. **性能测试**: 大图像处理和批量处理测试

### 代码审查清单
- [ ] 继承自`io.ComfyNode`
- [ ] 有`define_schema()`和`@classmethod execute()`
- [ ] 输出端口包含`display_name`
- [ ] 使用正确的v3类型
- [ ] 移除所有legacy兼容代码
- [ ] 错误处理完善

## 风险管理

### 技术风险
1. **v3 API变化**: 使用`comfy_api.latest`，定期检查更新
2. **前端兼容性**: 严格遵循兼容性规范，测试两种界面
3. **性能下降**: 进行性能基准测试和优化

### 迁移风险
1. **用户影响**: 未迁移节点暂不加载，降低影响
2. **工作流兼容性**: 保持数据格式一致，确保兼容
3. **测试覆盖**: 建立全面的测试体系

## 成功标准

### 技术成功标准
1. ✅ 所有55个节点迁移到v3架构
2. ✅ 节点在ComfyUI中正常加载和显示
3. ✅ 所有功能测试通过
4. ✅ 前端交互正常
5. ✅ 性能在可接受范围内
6. ✅ 代码符合v3 API规范

### 业务成功标准
1. ✅ 用户可以使用所有节点功能
2. ✅ 工作流兼容性保持
3. ✅ 迁移过程对用户透明
4. ✅ 文档更新完成

## 资源需求

### 时间资源
- **A级节点迁移**: 3周
- **S级节点迁移**: 待评估（预计4-6周）
- **测试和验证**: 每阶段1周
- **总计**: 预计8-10周

### 人力资源
- **AI代理**: 代码迁移和测试
- **用户验证**: 功能测试和验收
- **文档维护**: 更新文档和报告

## 沟通计划

### 进度报告
- **每日**: 代码提交和测试结果
- **每周**: 迁移进度报告更新
- **每阶段**: 总结报告和下一步计划

### 文档更新
- **迁移进度报告.md**: 实时更新状态
- **A级节点迁移计划.md**: 详细执行计划
- **v3架构迁移总计划.md**: 总体路线图

## 下一步行动

### 立即行动（今天）
1. ✅ 制定新的后端迁移策略
2. ✅ 调整节点加载机制
3. ✅ 创建A级节点迁移计划
4. ✅ 更新所有相关文档

### 短期行动（第1周）
1. 开始A级节点阶段1迁移
2. 迁移XIS_LoadImage节点
3. 建立测试用例模板
4. 更新节点清单状态

### 中期行动（第1-3周）
1. 按计划完成A级节点迁移
2. 进行全面的测试验证
3. 准备S级节点迁移规划

### 长期行动
1. 开始S级节点迁移
2. 性能优化和代码重构
3. 用户反馈收集和改进

---

**计划版本**: v1.0
**制定时间**: 2025-12-04
**状态**: 执行中
**最后更新**: 2025-12-04